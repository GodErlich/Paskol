<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Waveform Visualizer</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #000000;
            color: #ffffff;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        #visualizer-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px 0;
            aspect-ratio: 6/1;
            background: #000000;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #000000;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button, .file-label {
            padding: 10px 20px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover, .file-label:hover {
            background: #444;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="visualizer-container">
        <canvas id="visualizer"></canvas>
    </div>
    <div class="controls">
        <label class="file-label">
            Choose Audio File
            <input type="file" id="audio-input" accept="audio/*">
        </label>
        <button id="play-pause">Play</button>
    </div>
    <audio id="audio" style="display: none;"></audio>

    <script>
        const audioElement = document.getElementById('audio');
        const audioInput = document.getElementById('audio-input');
        const playPauseButton = document.getElementById('play-pause');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        // Set up Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 4096; // Increased for better resolution
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Float32Array(bufferLength);

        let audioSource = null;
        let animationId = null;
        let isPlaying = false;
        // Animation speed control
        

        // Set canvas size with higher resolution
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Handle file input
        audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                audioElement.src = fileURL;
                setupAudioSource();
            }
        });

        
        // Set up audio source
        function setupAudioSource() {
            if (audioSource) {
                audioSource.disconnect();
            }
            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);
        }

        // Play/Pause handler
        playPauseButton.addEventListener('click', function() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (isPlaying) {
                audioElement.pause();
                cancelAnimationFrame(animationId);
                playPauseButton.textContent = 'Play';
            } else {
                audioElement.play();
                draw();
                playPauseButton.textContent = 'Pause';
            }
            isPlaying = !isPlaying;
        });

        let lastDrawTime = 0;
        const frameInterval = 1000 / 10; // Target 30 FPS
        
        function draw(timestamp) {
            if (timestamp - lastDrawTime < frameInterval) {
                animationId = requestAnimationFrame(draw);
                return;
            }
            lastDrawTime = timestamp;
        
            animationId = requestAnimationFrame(draw);
            analyser.getFloatTimeDomainData(dataArray);
        
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        
            const centerY = canvas.height / 2;
            const scaling = canvas.height * 1.3;
            
            ctx.beginPath();
            ctx.moveTo(0, centerY);
        
            const sliceWidth = canvas.width / (bufferLength - 1);
            for (let i = 0; i < bufferLength; i++) {
                const x = i * sliceWidth;
                const value = Math.abs(dataArray[i]);
                const y = centerY - (value * scaling);
                ctx.lineTo(x, y * 0.8);
            }
        
            ctx.lineTo(canvas.width, centerY);
            ctx.lineTo(0, centerY);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
        }
        
        // Handle audio end
        audioElement.addEventListener('ended', function() {
            cancelAnimationFrame(animationId);
            isPlaying = false;
            playPauseButton.textContent = 'Play';
        });

        // Error handling
        audioElement.addEventListener('error', function(e) {
            console.error('Error playing audio:', e);
        });
    </script>
</body>
</html>